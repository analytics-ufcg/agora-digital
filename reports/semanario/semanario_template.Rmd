---
title: "Semanário Leg.go"
author: "Equipe Leg.go"
date: "06/10/2019"
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
params:
  date_init: 2019-09-30
  date_end: 2019-10-04
  num_semanas_passadas: 3
  proposicoes: 
    label: "Input dataset:"
    value: ../../data/tabela_geral_ids_casa.csv
    input: file
  temperaturas:
    label: "Input dataset:"
    value: ../../data/tabela_geral_ids_casa.csv
    input: file
  pressoes: 
    label: "Input dataset:"
    value: ../../data/tabela_geral_ids_casa.csv
    input: file
  atores:
    label: "Input dataset:"
    value: ../../data/tabela_geral_ids_casa.csv
    input: file
---

```{r knitr_init, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE, results="asis"}
library(magrittr)
knitr::opts_chunk$set(echo = FALSE,
	             cache = FALSE,
               prompt = FALSE,
               tidy = FALSE,
               comment = NA,
               message = FALSE,
               warning = FALSE)
```

```{r}
library(tidyverse)
library(here)
library(lubridate)
library(ggplot2)
library(plotly)
library(hrbrthemes)
library(grid)
library(gridExtra)
library(tibble)
library(ggchicklet)
```

<style>
body {
text-align: justify}
</style>

```{r, message=FALSE, warning=FALSE, include=FALSE}
#Base de dados de temperatura
temperatura <- params$temperaturas
pressao <- params$pressoes
data_inicio <- params$date_init
data_fim <- params$date_end
pls <- params$proposicoes
atores <- params$atores
num_semanas_passadas <- params$num_semanas_passadas
```

```{r}
#Funções

define_date_breaks <- function(timedata_df) {
  time_diff <- lubridate::interval( head(timedata_df, 1)$periodo, tail(timedata_df, 1)$periodo) / days()
  time_breaks <- as.integer(abs(time_diff/5))
  datas <- seq(ymd(head(timedata_df, 1)$periodo),ymd(tail(timedata_df, 1)$periodo), by = paste(time_breaks,"days"))  
}

build_temp_pressao_plot <- function(temp_pressao_pl, apelido_pl, dt_inicio, dt_fim) {
  datas <- define_date_breaks(temp_pressao_pl)
  data_n_semanas_atras <- as.Date(dt_fim) - (7 * num_semanas_passadas)
  temp_pressao_pl_n_semanas <- temp_pressao_pl %>% filter(periodo >= data_n_semanas_atras)
  
  p <- temp_pressao_pl %>% 
    ggplot(aes(x = periodo, y = sqrt(temperatura))) +
    geom_line(color="#DDDDDD") +
    geom_point(color=factor(ifelse(temp_pressao_pl$periodo==dt_inicio,"#EF476F","#DDDDDD")),
             size = ifelse(temp_pressao_pl$periodo==dt_inicio,3,1),
             width=0.5) +
    geom_col(aes(x = periodo, y = -sqrt(pressao), width = 4), fill=factor(ifelse(temp_pressao_pl$periodo==dt_inicio,"#FFD166","#DDDDDD")), show.legend = FALSE ) +
    geom_line(data =  temp_pressao_pl_n_semanas, aes(x = periodo, y = sqrt(temperatura)), color="#EF476F") +
  geom_col(data =  temp_pressao_pl_n_semanas, aes(x = periodo, y = -sqrt(pressao), width = 4), fill=factor("#FFD166"), show.legend = FALSE ) +
    labs(x = "Semana", 
         y = "",
         title = "Temperatura e pressão ao longo das semanas",
         subtitle = apelido_pl) +
    scale_x_date(date_labels = "%d de %b", breaks = datas) +
    theme_ipsum_rc(grid = FALSE) +
    theme(axis.text.y = element_blank(), 
          axis.text.x = element_text(angle = 0, vjust = 0.5)) +
    theme(axis.text.x = element_text(color = "gray60", size = 8))
  
  grob <- grobTree(textGrob("Temperatura", x=0.1,  y=0.95, hjust=0,
    gp=gpar(col="black", fontsize=10, alpha = 0.3, fontfamily = "Roboto", fontface = "bold")))
  
  grob2 <- grobTree(textGrob("Pressão", x=0.1,  y=.1, hjust=0,
    gp=gpar(col="black", fontsize=10, alpha = 0.3, fontfamily = "Roboto", fontface = "bold")))
  
  p  + annotation_custom(grob) + annotation_custom(grob2)  
  
}

join_temp_pressao <- function(temperatura_df, pressao_df) {
  temperatura_ <- temperatura_df %>% 
    mutate(periodo = as.Date(periodo))

  temp_pressao <- dplyr::inner_join(temperatura_, pressao_df, by =c("id_leggo","periodo")) %>% 
    dplyr::select(id_leggo, periodo, temperatura, pressao) %>% 
    mutate(pressao = if_else(pressao == 0, 0.1, pressao))
  return(temp_pressao)
}
```

## Pressão e Temperatura

```{r, fig.height=7, fig.width=10}
temp_pressao_periodo <- join_temp_pressao(temperatura, pressao)

pls_nome_formal <- pls %>% 
  mutate(ano = format(as.Date(data_apresentacao), "%Y")) %>% 
  mutate(nome_formal = paste0(sigla_tipo, ' ', numero, '/', as.character(ano))) %>% 
  mutate(nome_formal_completo = paste0(nome_formal, ' (', tools::toTitleCase(ifelse(casa == "camara","Câmara",casa)), ')'))

pls_destaque <- pls_nome_formal %>%
  filter(id_leggo %in% temp_pressao_periodo$id_leggo)

# build_temp_pressao_plot(temp_pressao_periodo, paste(pl_destaque$nome_formal,pl_destaque$apelido,sep=" - "), data_fim)
```

```{r temp_pressao_prop_destaque, include=FALSE}
temp_press = c()
for (i in 1:nrow(pls_destaque)) {
  print(paste("Rodando iteração ",i))

  pl_destaque <- pls_destaque %>%
    slice(i)

  apelido_pl <- paste(pl_destaque$nome_formal,pl_destaque$apelido,sep=" - ")
  dt_inicio <- data_inicio
  dt_fim <-   data_fim
  pl_chunk_label <- paste('temp_pressao',pl_destaque$id_ext,pl_destaque$casa,sep='-')

  temp_pressao_pl <- temp_pressao_periodo %>%
    filter(id_leggo == pl_destaque$id_leggo)

  temp_press = c(temp_press, knitr::knit_child('temp_pressao_semanario_template.Rmd'))
}
```
`r paste(knitr::knit(text = temp_press), collapse = '\n')`

```{r}
est_prev <- tail(temp_pressao_periodo, 2)
temp_atual <- est_prev$temperatura[length(est_prev$temperatura)]
ultima_temp <- est_prev$temperatura[length(est_prev$temperatura) - 1]
variacao_temp <- round(((temp_atual - ultima_temp) / ultima_temp) * 100, digits = 2)
press_atual <- est_prev$pressao[length(est_prev$pressao)]
ultima_press <- est_prev$pressao[length(est_prev$pressao) - 1]
variacao_press <- press_atual - ultima_press
cresceu_temp <- variacao_temp > 0
cresceu_press <- variacao_press > 0
variacao_temp <- abs(variacao_temp)
variacao_press <- abs(variacao_press)
```


Foi observad`r if(cresceu_temp){"o um crescimento de "}else{"a uma diminuição de "}` `r variacao_temp`% na temperatura e `r if(cresceu_press){"um crescimento de "}else{ if(variacao_press == 0){"não foi observada nenhuma mudança"}else{"uma diminuição de "}}` `r if(variacao_press != 0){variacao_press}``r if(variacao_press != 0){"%"}` na pressão.

## Atores da semana

```{r}
#Base de dados de atuações e filtros por data

oposicao <- c("PT", "PSOL", "PSB", "PCdoB", "PDT", "REDE")

atores_geral <- atores %>% 
  mutate(partido = if_else(is.na(partido), "-", partido), 
         uf = if_else(is.na(uf), "-", uf),
         nome_completo = paste0(nome_autor, " (",partido,"/",uf,")")) %>% 
  left_join(pls_nome_formal %>% select(id_leggo, id_ext, casa, nome_formal, nome_formal_completo, sigla_tipo), by=c("id_leggo","id_ext","casa")) %>% 
  mutate(bancada = if_else(partido %in% oposicao, "Oposição", "Governo"))

atores_pls <- atores_geral %>% 
  dplyr::group_by(id_leggo, id_ext, casa, nome_autor, id_autor, tipo_autor, partido, nome_completo,
           uf, tipo_generico, sigla_local, is_important, bancada, nome_formal, nome_formal_completo, sigla_tipo, tema) %>% 
  dplyr::summarise(qtd_de_documentos = sum(qtd_de_documentos))

atuacao_temas <- atores_pls %>% 
  dplyr::group_by(bancada, tema) %>% 
  dplyr::summarise(qtd_de_documentos = sum(qtd_de_documentos))

atuacao_bancadas <- atores_pls %>% 
  dplyr::group_by(casa, bancada, nome_formal, nome_formal_completo, sigla_tipo) %>% 
  dplyr::summarise(qtd_de_documentos = sum(qtd_de_documentos))
```

```{r, fig.height=6, fig.width=10}
p <- atuacao_temas %>% ggplot(aes(x = reorder(tema, qtd_de_documentos), y = qtd_de_documentos, group = bancada, fill = bancada)) + 
    geom_chicklet(width = 0.75) +
     theme_ipsum_rc(grid=FALSE) +
     theme(legend.position = "bottom") +
     labs(
      x = NULL, y = "Quantidade de documentos", fill = NULL,
      title = "Atuações das bancadas por tema",
      subtitle = "Documentos autorados pelos parlamentares \nna última semana",
      caption = ""
     ) + 
     scale_fill_manual(
     name = NULL,
     values = c(
      "Governo" = "#436f82",
      "Oposição" = "#ae4544"
     )) +
     coord_flip()
p <- p + theme_ipsum_rc(grid=FALSE)
p <- p + theme(axis.text.x = element_text(angle = 0, vjust = 0.5)) +theme(axis.text.x = element_text(color = "gray60", size = 10)) +
  theme(legend.position = "top")
p

qtd_tema <-
  atuacao_temas %>% 
  group_by(tema) %>% 
  summarise(total = sum(qtd_de_documentos)) 

tema_destaque <-
  qtd_tema %>% 
  arrange(total) %>% 
  tail(1) %>% 
  purrr::pluck("tema")

total_docs <- sum(qtd_tema$total)
total_tema_destaque <- qtd_tema %>% filter(tema == tema_destaque) %>% purrr::pluck("total")
variacao_temp <- round(((total_tema_destaque * 100) / total_docs), digits = 2)
atuacao_temas_destaque <- atuacao_temas %>% filter(tema == tema_destaque)
pls_tema_destaque <- atores_pls %>%  filter(tema == tema_destaque)
num_docs_governo <- atuacao_temas_destaque %>% filter(bancada == "Governo") %>% purrr::pluck("qtd_de_documentos")
num_docs_oposicao <- atuacao_temas_destaque %>% filter(bancada == "Oposição") %>% purrr::pluck("qtd_de_documentos")
```

Na última semana o tema `r tema_destaque` teve destaque nas atuações parlamentares, sendo `r variacao_temp`% dos documentos autorados para esse tema. Outro destaque é que foram apresentados `r num_docs_governo` documentos pela bancada do governo e `r num_docs_oposicao` pela oposição.

Ao clicar no tema `r tema_destaque`, temos as seguintes proposições tiveram destaque

```{r, fig.height=6, fig.width=10}
p <- atuacao_bancadas %>% filter(nome_formal %in% pls_tema_destaque$nome_formal) %>%  ggplot(aes(x = reorder(nome_formal, qtd_de_documentos), y = qtd_de_documentos, group = bancada, fill = bancada)) + 
    geom_chicklet(width = 0.75) +
     theme_ipsum_rc(grid=FALSE) +
     theme(legend.position = "bottom") +
     labs(
      x = NULL, y = "Quantidade de documentos", fill = NULL,
      title = "Atuações das bancadas por proposição",
      subtitle = "Documentos autorados pelos parlamentares \nna última semana",
      caption = ""
     ) +
     scale_fill_manual(
     name = NULL,
     values = c(
      "Governo" = "#436f82",
      "Oposição" = "#ae4544"
     )) +
     coord_flip()
p <- p + theme_ipsum_rc(grid=FALSE)
p <- p + theme(axis.text.x = element_text(angle = 0, vjust = 0.5)) +theme(axis.text.x = element_text(color = "gray60", size = 10)) +
  theme(legend.position = "top")
p

qtd_atuacao <-
  atuacao_bancadas %>% 
  group_by(nome_formal, nome_formal_completo) %>% 
  summarise(total = sum(qtd_de_documentos)) 

props_destaque <-
  qtd_atuacao %>% 
  arrange(total) %>% 
  filter(total >= 5) %>% 
  ungroup()

prop_destaque <-
  qtd_atuacao %>% 
  arrange(total) %>% 
  tail(1) %>% 
  purrr::pluck("nome_formal")

total_prop_destaque <- qtd_atuacao %>% filter(nome_formal == prop_destaque) %>% purrr::pluck("total")
atuacao_prop_destaque <- atuacao_bancadas %>% filter(nome_formal == prop_destaque)
num_docs_governo <- atuacao_prop_destaque %>% filter(bancada == "Governo") %>% purrr::pluck("qtd_de_documentos")
num_docs_oposicao <- atuacao_prop_destaque %>% filter(bancada == "Oposição") %>% purrr::pluck("qtd_de_documentos")
```

A `r prop_destaque` teve maior número de atuações, com apresentação de `r total_prop_destaque` documentos, sendo `r num_docs_governo` apresentados pelo governo e `r num_docs_oposicao` pela oposição.

Ao clicar na proposição `r prop_destaque` temos mais detalhes sobre os atores e os respectivos documentos apresentados.

```{r atores_prop_destaque, include=FALSE}
out = NULL
for (i in 1:nrow(props_destaque)) {
  print(paste("Rodando iteração ",i))
  curr_prop_nome_formal_completo <- (props_destaque %>%  slice(i))$nome_formal_completo
  curr_prop_destaque <- (props_destaque %>% slice(i))$nome_formal
  atores_prop_destaque <- atores_pls %>%
    filter(nome_formal %in% curr_prop_destaque)
  pl_chunk_label <- paste('atores',pl_destaque$id_ext,pl_destaque$casa,sep='-')
  #knitr::opts_chunk$set(label = pl_chunk_label)
  out = c(out, knitr::knit_expand('atores_semanario_template.Rmd'))
}
```
`r paste(knitr::knit(text = out), collapse = '\n')`