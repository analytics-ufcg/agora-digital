---
title: "Relatório de coautoria"
runtime: shiny
output:
  html_document:
    code_folding: hide
    css: style.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.cap = '',
  fig.align = 'center',
  fig.width = 10,
  fig.height = 8
)
```

```{r echo = FALSE, warning=FALSE, message=FALSE}
library(networkD3)
library(tidyverse)
library(shiny)
library(hrbrthemes)
library(rcongresso)
theme_set(theme_minimal())
source(here::here('reports/rede-de-atuacao/scripts/prepare_coautorias_data.R'))


env <- "dev"
path <- ''

if (env == "dev") {
  path = "reports/coautorias-por-prop/"
} 

# Lendo documentos e autores de ambas as casas para processar as coautorias
documentos_camara <- 
  agoradigital::read_current_docs_camara("data/documentos_camara.csv") %>% 
  mutate(data = as.Date(format(status_proposicao_data_hora, "%Y-%m-%d")))
documentos_senado <- agoradigital::read_current_docs_senado("data/documentos_senado.csv")
autores_camara <- agoradigital::read_current_autores_camara("data/autores_camara.csv")
autores_senado <- agoradigital::read_current_autores_senado("data/autores_senado.csv")

# Gerando dado de autorias de documentos para ambas as casas
autorias_camara <- prepare_autorias_df_camara(documentos_camara, autores_camara)
autorias_senado <- prepare_autorias_df_senado(documentos_senado, autores_senado)

peso_autorias_docs_camara <- compute_peso_autoria_doc(autorias_camara)
peso_autorias_docs_senado <- compute_peso_autoria_doc(autorias_senado)

parlamentares_camara <- autores_camara %>% dplyr::select(id_autor, nome, partido, uf)
parlamentares_senado <- autores_senado %>% dplyr::select(id_autor, nome = nome_autor, partido, uf)

senadores <- agoradigital::read_senadores('data/parlamentares.csv')
props <- 
  read_csv('data/proposicoes.csv') %>% 
  mutate(descricao_lei = paste0(apelido, "- ", sigla_tipo, " ", numero, "/", format(data_apresentacao, "%Y"), " - ", casa)) %>% 
  select(id_principal = id_ext, descricao_lei) %>% 
  mutate(id_principal = as.character(id_principal))

coautorias_camara <- get_coautorias(peso_autorias_docs_camara, autorias_camara, parlamentares_camara)
coautorias_senado <- get_coautorias(peso_autorias_docs_senado, autorias_senado, parlamentares_senado)

coautorias <- 
  rbind(coautorias_camara, coautorias_senado) %>% left_join(props, by = "id_principal") %>% 
  filter(nome.x != nome.y) %>% 
  mutate(partido.x = if_else(is.na(partido.x), "", partido.x),
         partido.y = if_else(is.na(partido.y), "", partido.y))

props <- props %>% 
  filter(id_principal %in% coautorias$id_principal)

```


### As proposições

Para a geração deste relatório, foram utilizadas as proposições da plataforma [Leggo](https://leggo.org.br). Para cada uma das proposições, existe uma série de outras proposições relacionadas, como emendas, pareceres, requerimentos, etc., que também foram consideradas para a criação dos grupos parlamentares. 

<br>

### A detecção dos grupos

A detecção de grupos é feita combinando em pares os autores de todas as proposições e suas respectivas relacionadas. Isso quer dizer que, para uma proposição do tipo requerimento que foi feito por 3 autores, x, y e z, serão criados 3 pares: um contendo x e y, um com x e z e outro com y e z. Desta forma, cada um dos deputados autores de uma proposição terá uma relação com todos os outros coautores. 

<br>

#### Tabela de pares

A tabela abaixo lista todos os pares e respectivas relações, calculadas de acordo com o peso explicado abaixo. 
```{r echo=FALSE}
DT::DTOutput("dt")
```

<br>

#### Peso das relações 

A fim de deixar os grupos mais refinados e precisos, optamos por adicionar uma penalidade que varia de acordo com o número de pessoas envolvidas: quanto mais coautores em uma proposição, menos precisas estarão as relações entre os deputados e por isso terão pesos menores; de forma análoga, uma proposição que possua apenas dois coautores, terá o peso da relação máximo e estarão muito mais próximos. **Utilizamos o peso mínimo de 0.01 das relações**.

<br>

```{r echo=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
plotOutput("hist")
```

#### Rede de grupos

<br>

##### Grafo Geral:
Este são todos os agrupamentos da proposição.

```{r echo=FALSE, fig.width = 4, fig.height = 4}
choices_ids <- 
  props %>% 
  select(descricao_lei) %>%
  as.list() 

choices_ids <- choices_ids$descricao_lei

selectInput("descricao_lei", "Descrição da Lei",
             choices_ids,
            selected = choices_ids[1])
br()

forceNetworkOutput("grafo")
```

Observando a rede acima, não dá pra saber quais são os partidos predominantes, então veremos a distribuição partidária deste grupo no histograma abaixo:

```{r echo=FALSE, fig.width = 4, fig.height = 3}
plotOutput("hist_grafo")
```


```{r echo=FALSE, fig.width = 4, fig.height = 4}
# forceNetworkOutput("grafo_grupo2")
```

```{r echo=FALSE}

# generate_graph_by_group <- function(df, id_group) {
#   nodes <- df[[1]] %>%
#   filter(group == id_group)
# 
#   return(list(nodes, df[[2]]))
# }

generate_graph_by_group <- function(df, id_group) {
  nodes <- df[[1]] %>%
  filter(group == id_group) %>% 
    select(-index) %>% 
    rowid_to_column("index") %>% 
    mutate(index = index - 1)
  
  edges <- generate_edges(coautorias, nodes)
  
  return(list(nodes, edges))
}

generate_graph <- function(nodes, edges) {
  fn <- forceNetwork(
    Links = edges, 
    Nodes = nodes,
    Source = "source", 
    Target = "target",
    Value = "value", 
    linkDistance = 150,
    NodeID = "nome_eleitoral",
    Nodesize = "node_size",
    Group ="partido", 
    zoom = T,
    linkColour = "#bfbdbd",
    fontFamily = "roboto",
    fontSize = 16,
    charge = -50,
    opacity = 0.8)
  
  fn <- 
        htmlwidgets::onRender(fn, 
                                '
          function(el,x) {
            var tooltip = d3.select("body")
          	  .append("div")
          	  .style("position", "absolute")
          	  .style("z-index", "10")
          	  .style("visibility", "hidden")
          	  .style("background-color", "#ffffff")
          	  .style("padding", "5px")
          	  .style("border", "solid 2px #000")
          	  .style("border-radius", "6px")
          	  .style("font-size", "1.2rem")

            d3.selectAll(".node")
              .on("mouseover", null)
              .style("opacity", 1)
              .style("cursor", "pointer");

            d3.selectAll("circle")
              .on("mouseover", function(d) { 
                  return tooltip.html(d.name )
                    .style("visibility", "visible")
                    .style("top",(event.pageY-10)+"px")
                    .style("left",(event.pageX+10)+"px");})
        	    .on("mouseout", function(d) {
                  return tooltip.html(d.name)
                    .style("visibility", "hidden");});
            }
              '
        )
  
  return(fn)
}

getCoautorias <- reactive({
  nodes_edges <- 
    generate_nodes_and_edges(
      coautorias %>% 
      filter(descricao_lei == input$descricao_lei)) 
  return(nodes_edges)
})

```

```{r echo=FALSE, context="server"}
getPesosProp <- function(descricao_lei) {
  coautorias %>% 
    filter(descricao_lei == descricao_lei) %>% 
    select(peso_arestas) %>% 
    as.list() %>% 
    purrr::pluck("peso_arestas")
}

output$hist <- renderPlot({
  if(nrow(coautorias) > 0) {
    coautorias_hist <- 
      coautorias %>%
      filter(descricao_lei == input$descricao_lei)
    
    if(nrow(coautorias_hist) != 0) {
      coautorias_hist %>% 
        ggplot(aes(x = peso_arestas)) +
        geom_histogram(boundary = 0, fill = "#1BB5A9", color = "#10726B") +
        scale_x_continuous(limits = c(0, max(coautorias$peso_arestas) + 0.1), 
                           breaks = seq(0, max(coautorias$peso_arestas) + 0.1, 1)) +
        labs(x = "Peso das relações", y = "Número de relações") +
        theme_ipsum_rc()
    }
  }
})

output$dt <- 
  DT::renderDataTable(
    coautorias %>% 
      select(id_principal, nome.x, nome.y, peso_arestas, num_coautorias, descricao_lei, data) %>% 
      distinct() %>% 
      filter(descricao_lei == input$descricao_lei) %>% 
      rename(peso_relacao = peso_arestas, 
             nome_deputado_a = nome.x,
             nome_deputado_b = nome.y,
             coautorias_conjuntas = num_coautorias) %>% 
      arrange(desc(peso_relacao)), 
    options = list(pageLength = 10,
                   scrollX = TRUE)
    )
  
output$grafo <- 
  networkD3::renderForceNetwork({
      graph <- getCoautorias()
    if(nrow(graph[[1]]) > 0 & nrow(graph[[2]]) > 0) {
      generate_graph(graph[[1]], graph[[2]])
    } else {
      NA
    }
  })

output$hist_grafo <- renderPlot({ 
  nodes <-getCoautorias()[[1]]
  if(nrow(nodes) > 0) {
    nodes <- nodes %>%
      group_by(partido) %>% 
      count() 
    
    nodes %>% 
    ggplot(aes(x = reorder(partido, n), y = n)) +
      geom_bar(fill = "#1BB5A9", color="#10726B", stat="identity") +
      coord_flip() +
      labs(x = "Partido", y = "Número de deputados") +
      scale_y_continuous(breaks = seq(0, max(nodes$n), 1)) +
      theme_ipsum_rc()
  }
})

```

Para a lei do Licenciamento Ambiental (PL 3729/2004) houve 4 grandes grupos,
Um composto por 13 deputados do PT e 2 deputados do PSOL
Outro composto por 8 do PMDB na época que requeria o desapensamento do PL 1546/2015 que estava apensado ao PL 3729/2004
Outro composto por deputados de vários partidos (PTB, PP , PSDB, PSB, DEM, PDT, PT, PSD)
Outro composto por 4 do PV, 2 do PSOL, 2 do Solidariedade e PR, PT, PRB e PSDB que foi a PL 1147/2007 que foi apensada
E um do PSDB e PP que apresentaram a PL 358/2011 que foi apensada

```{r echo=FALSE, fig.width = 4, fig.height = 4}
br()

coautorias_lei_licenciamento <-
  coautorias %>%
  filter(descricao_lei == "Lei do Licenciamento Ambiental- PL 3729/2004 - camara")
  
  networkD3::renderForceNetwork({
      graph <- generate_nodes_and_edges(coautorias_lei_licenciamento)
    if(nrow(graph[[1]]) > 0 & nrow(graph[[2]]) > 0) {
      generate_graph(graph[[1]], graph[[2]])
    } else {
      NA
    }
  })
  
br()
```

Tiago Mitraud - NOVO/MG apresentou uma emenda aditiva com Marcelo Calero - CIDADANIA/RJ
Tabata Amaral - PDT/SP apresentou com Felipe Rigoni - PSB/ES uma emenda aditiva e um requerimento de audiência pública 
Felipe Rigoni - PSB/ES
Adriana Ventura - NOVO/SP
João H. Campos - PSB/PE
Emanuel Pinheiro Neto - PTB/MT
Tiago Mitraud - NOVO/MG
Jhc - PSB/AL apresentaram uma emenda aditiva
E os deputados do pt apresentaram uma emenda
Podemos ver também, que Felipe Rigoni foi o parlamentar que mais teve peso nos documentos no segundo grupo
```{r echo=FALSE, fig.width = 4, fig.height = 4}
coautorias_2019 <-
  coautorias %>% 
  filter(data > "2019-01-01")

coautorias_pec_aborto <-
  coautorias_2019 %>% 
  filter(descricao_lei == "Tornar o FUNDEB permanente (Câmara)- PEC 15/2015 - camara")

  networkD3::renderForceNetwork({
      graph <- generate_nodes_and_edges(coautorias_pec_aborto)
    if(nrow(graph[[1]]) > 0 & nrow(graph[[2]]) > 0) {
      generate_graph(graph[[1]], graph[[2]])
    } else {
      NA
    }
  })

  
br()
```
