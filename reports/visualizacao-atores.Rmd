---
title: "Top Atores"
author: "Matheus Leal"
date: "June 25, 2019"
output: html_document
---

```{r}
library(tidyverse)
library(ggplot2)
library(plotly)
camara_env <- jsonlite::fromJSON(here::here("R/config/environment_camara.json"))
```

```{r}
atores_raw <- read_csv("../data/atores.csv")
tipos_documentos <- atores_raw %>%
  select(descricaoTipo = descricao_tipo) %>%
  agoradigital::add_tipo_evento_documento() %>% 
  select(tipo_generico = tipo)

atores_tipos_docs <- atores_raw %>% 
  bind_cols(tipos_documentos) %>% 
  select(id_principal, casa, id_autor, nome_autor, codTipo, sigla_tipo, descricao_tipo, tipo_generico, qtd_de_documentos, sigla_orgao)


```

```{r}
plot_prop <- function(id, name) {
  atores_prop <- 
    atores_tipos_docs %>% 
    filter(id_principal == id) %>% 
    group_by(nome_autor, tipo_generico) %>% 
    summarise(num_eventos_unicos = sum(qtd_de_documentos))

  atores_grouped <- 
    atores_prop %>% 
    group_by(nome_autor) %>% 
    summarise(num_eventos_unicos = sum(num_eventos_unicos)) %>% 
    arrange(desc(num_eventos_unicos)) %>% 
    head(5) %>% 
    select(nome_autor)
  
  atores_prop <- atores_prop %>% filter(nome_autor %in% atores_grouped$nome_autor)
  
  p <- ggplot(atores_prop, aes(x = reorder(nome_autor, -num_eventos_unicos, sum),
                               y = num_eventos_unicos,
                               fill = tipo_generico))+
    geom_col() + 
    scale_colour_brewer("", palette="Set3", aesthetics = "fill") +
    xlab("Autor") +
    ylab("Quantidade de Documentos") +
    labs(fill = "Documentos", title = name)
    
  
  ggplotly(p)
}
  

```

```{r}
plot_prop(2192459, "PEC 6/2019 - Nova Previdência") 
plot_prop(16526, "PL 1292/1995 - PL das Compras Públicas (Nova Lei de Licitações)")
plot_prop(2193540, "PL 1321/2019 - Anistia Tributária para Partidos")
```


## Gráfico por comissão
```{r}
plot_prop_comissoes <- function(id, name) {
  atores_prop <- 
    atores_tipos_docs %>% 
    filter(id_principal == id) %>% 
    group_by(nome_autor, tipo_generico, sigla_orgao) %>% 
    summarise(num_eventos_unicos = sum(qtd_de_documentos))

  atores_grouped <- 
    atores_prop %>% 
    group_by(nome_autor) %>% 
    summarise(num_eventos_unicos = sum(num_eventos_unicos)) %>% 
    arrange(desc(num_eventos_unicos)) %>% 
    head(5) %>% 
    select(nome_autor)
  
  atores_prop <- atores_prop %>%
    filter(nome_autor %in% atores_grouped$nome_autor) %>% 
    filter(sigla_orgao %in% c(camara_env$comissoes$siglas_comissoes, "PLEN"))
  
  p <- ggplot(atores_prop, aes(x = reorder(nome_autor, -num_eventos_unicos, sum),
                               y = num_eventos_unicos,
                               fill = tipo_generico))+
    geom_col() + 
    scale_colour_brewer("", palette="Set3", aesthetics = "fill") +
    facet_grid(rows = vars(sigla_orgao))+
    xlab("Autor") +
    ylab("Quantidade de Documentos") +
    labs(fill = "Documentos", title = name) 
  
  ggplotly(p)
}
plot_prop_comissoes(2192459, "PEC 6/2019 - Nova Previdência") 
plot_prop_comissoes(16526, "PL 1292/1995 - PL das Compras Públicas (Nova Lei de Licitações)")
plot_prop_comissoes(604557, "PL 6969/2013 - PNCMar")
plot_prop_comissoes(2193540, "PL 1321/2019 - Anistia Tributária para Partidos")
```

