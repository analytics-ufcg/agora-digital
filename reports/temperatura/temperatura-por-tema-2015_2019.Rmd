---
title: "Temperatura da Proposição por Temas"
output:
  html_document:
    df_print: paged
    code_folding: "hide"
  html_notebook: default
---

Neste relatório, faremos uma análise histórica da Temperatura das proposições agregadas por tema ao longo dos anos.

```{r warning=FALSE, message=FALSE}
library(dplyr)
library(magrittr)
library(ggplot2)
library(plotly)

temperatura_props <- readr::read_csv('../../data/hists_temperatura.csv')
proposicoes <- readr::read_csv('../../data/proposicoes.csv')
eventos <- readr::read_csv('../../data/trams.csv')
temas_props <- proposicoes %>% 
  mutate(nome_pl = paste(sigla_tipo, paste(numero, lubridate::year(data_apresentacao),sep='/'))) %>%
  select(id_ext, nome_pl, apelido, tema)

temperatura_props_temas <- inner_join(temperatura_props,temas_props,by = "id_ext") %>%
  tidyr::separate_rows(tema,sep=';') %>%
  mutate(semana = lubridate::floor_date(periodo, "weeks") + lubridate::days(1),
         ano = lubridate::year(periodo)) %>%
  arrange(semana,ano,tema,desc(temperatura_recente))

eventos_semanais <- eventos %>%
  mutate(semana = lubridate::floor_date(data, "weeks") + lubridate::days(1),
         ano = lubridate::year(data))
  
evolucao_semanal_temperatura <- temperatura_props_temas %>%
  group_by(id_ext) %>%
  arrange(ano,semana) %>%
  mutate(evolucao_temp_recente = temperatura_recente - lag(temperatura_recente, default = 0)) %>%
  ungroup() %>%
  arrange(id_ext,ano,semana)

test <- evolucao_semanal_temperatura %>%
  filter(temperatura_periodo > 0 & evolucao_temp_recente < 0)
  

temperatura_temas <- temperatura_props_temas %>%
  group_by(tema,semana,ano) %>%
  summarise(num_obs = n(),
            total_temp = sum(temperatura_recente),
            min_temp = min(temperatura_recente),
            max_temp = max(temperatura_recente),
            total_temp = mean(temperatura_recente),
            mean_temp = median(temperatura_recente),
            std_temp = sd(temperatura_recente),
            var_temp = var(temperatura_recente))
```

Temperatura Geral na legislatura anterior (2015-2018).

```{r}
p <- temperatura_temas %>% 
  dplyr::filter((ano >= 2015) && (ano <= 2018)) %>%
  ggplot2::ggplot(ggplot2::aes(x=as.Date(semana), y=total_temp)) +
  ggplot2::geom_col(position="dodge") +
  ggplot2::xlab("Tempo") + 
  ggplot2::ylab("Temperatura") +
  ggplot2::scale_x_date(date_labels = "%d-%m-%Y") +
  ggplot2::theme_minimal()

ggplotly(p)

```

Repetindo a análise separada por tema para a legislatura anterior (2015-2018).

```{r}
p <- temperatura_temas %>% 
  dplyr::filter((ano >= 2015) && (ano <= 2018)) %>%
  ggplot2::ggplot(ggplot2::aes(x=as.Date(semana), y=total_temp, fill=tema)) +
  ggplot2::geom_bar(stat="identity", position="dodge") +
  ggplot2::xlab("Tempo") + 
  ggplot2::ylab("Temperatura") +
  ggplot2::theme_minimal() +
  ggplot2::scale_x_date(date_labels = "%d-%m-%Y") +
  ggplot2::facet_grid(rows = vars(tema)) + 
  ggplot2::theme(strip.background = element_blank(),
                 strip.text.y = element_blank())

ggplotly(p)

```

Agora, vamos fazer a mesma análise pra cada ano individualmente.

Temperatura Geral em 2018.

```{r}
p <- temperatura_temas %>% 
  dplyr::filter(ano == 2018) %>%
  ggplot2::ggplot(ggplot2::aes(x=as.Date(semana), y=total_temp)) +
  ggplot2::geom_col(position="dodge") +
  ggplot2::xlab("Tempo") + 
  ggplot2::ylab("Temperatura") +
  ggplot2::scale_x_date(date_labels = "%d-%m-%Y") +
  ggplot2::theme_minimal()

ggplotly(p)

```

Repetindo a análise separada por tema para o ano de 2018.

```{r}
p <- temperatura_temas %>% 
  dplyr::filter(ano == 2018) %>%
  ggplot2::ggplot(ggplot2::aes(x=as.Date(semana), y=total_temp, fill=tema)) +
  ggplot2::geom_bar(stat="identity", position="dodge") +
  ggplot2::xlab("Tempo") + 
  ggplot2::ylab("Temperatura") +
  ggplot2::theme_minimal() +
  ggplot2::scale_x_date(date_labels = "%d-%m-%Y") +
  ggplot2::facet_grid(rows = vars(tema)) + 
  ggplot2::theme(strip.background = element_blank(),
                 strip.text.y = element_blank())

ggplotly(p)

```

```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Meio Ambiente",
                     semana = lubridate::ymd(c('2018-06-04','2018-06-18')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_tema <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(evolucao_temp_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(evolucao_temp_recente))

evolucao_semanal_temperatura_tema
```


Temperatura Geral em 2017.

```{r}
p <- temperatura_temas %>% 
  dplyr::filter(ano == 2017) %>%
  ggplot2::ggplot(ggplot2::aes(x=as.Date(semana), y=total_temp)) +
  ggplot2::geom_col(position="dodge") +
  ggplot2::xlab("Tempo") + 
  ggplot2::ylab("Temperatura") +
  ggplot2::scale_x_date(date_labels = "%d-%m-%Y") +
  ggplot2::theme_minimal()

ggplotly(p)

```

Repetindo a análise separada por tema para o ano de 2017.

```{r}
p <- temperatura_temas %>% 
  dplyr::filter(ano == 2017) %>%
  ggplot2::ggplot(ggplot2::aes(x=as.Date(semana), y=total_temp, fill=tema)) +
  ggplot2::geom_bar(stat="identity", position="dodge") +
  ggplot2::xlab("Tempo") + 
  ggplot2::ylab("Temperatura") +
  ggplot2::theme_minimal() +
  ggplot2::scale_x_date(date_labels = "%d-%m-%Y") +
  ggplot2::facet_grid(rows = vars(tema)) + 
  ggplot2::theme(strip.background = element_blank(),
                 strip.text.y = element_blank())

ggplotly(p)

```

