#' @title Regex left match
#' @description Identifica eventos por regex e adiciona uma nova coluna
#' @param df dataframe a ser adicionado nova coluna
#' @param regex_df dataframe dos regex
#' @param new_column nova coluna
#' @return Dataframe com os eventos detectados pelo regex
#' @importFrom magrittr %<>%
#' @export
regex_left_match <- function(df, regex_df, new_column) {
  if('despacho' %in% names(regex_df)) {
    df %<>%
      dplyr::mutate(UQ(rlang::sym('despacho')) := stringr::str_replace_all(UQ(rlang::sym('despacho')), '\n|\r', ''))
  }
  if('texto_tramitacao' %in% names(regex_df)) {
    df %<>%
      dplyr::mutate(UQ(rlang::sym('texto_tramitacao')) := stringr::str_replace_all(UQ(rlang::sym('texto_tramitacao')), '\n|\r', ''))
  }

  columns <-
    names(regex_df)[names(regex_df) != new_column] %>% sapply(function(x) {
      paste0(x, "X")
    }
    , USE.NAMES = TRUE)
  names(regex_df) %<>% sapply(function(column) {
    if (column == new_column)
      column
    else
      paste0(column, "X")
  }
  , USE.NAMES = TRUE)
  
  regex_df[is.na(regex_df)] <- ".*"
  
  df %>%
    dplyr::mutate(sort = row_number()) %>%
    fuzzyjoin::regex_left_join(regex_df, by = columns, ignore_case = TRUE) %>%
     group_by(sort) %>%
     ungroup() %>%
    dplyr::select(-tidyselect::ends_with("X"), -sort)

}

#' @title Renomeia as colunas do dataframe
#' @description Renomeia as colunas do dataframe usando o padrão de letras minúsculas e underscore
#' @param df Dataframe
#' @return Dataframe com as colunas renomeadas.
#' @importFrom magrittr %<>%
#' @export
rename_df_columns <- function(df) {
  names(df) %<>% to_underscore
  df
}

#' @title Renomeia um vetor com o padrão de underscores e minúsculas
#' @description Renomeia cada item do vetor com o padrão: separado por underscore e letras minúsculas
#' @param x Vetor de strings
#' @return Vetor contendo as strings renomeadas.
#' @examples
#' to_underscore(c("testName", "TESTNAME"))
#' @export
to_underscore <- function(x) {
  gsub('([A-Za-z])([A-Z])([a-z])', '\\1_\\2\\3', x) %>%
    gsub('.', '_', ., fixed = TRUE) %>%
    gsub('([a-z])([A-Z])', '\\1_\\2', .) %>%
    tolower()
}
